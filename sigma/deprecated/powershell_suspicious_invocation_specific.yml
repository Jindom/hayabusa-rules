
title: Suspicious PowerShell Invocations - Specific
ruletype: Sigma
author: Florian Roth (rule), Jonhnathan Ribeiro
date: 2017/03/05
description: Detects suspicious PowerShell invocation command parameters
detection:
  SELECTION_1:
  - -nop
  SELECTION_10:
  - ' -c '
  SELECTION_11:
  - iex
  SELECTION_12:
  - New-Object
  SELECTION_13:
  - ' -w '
  SELECTION_14:
  - hidden
  SELECTION_15:
  - -ep
  SELECTION_16:
  - bypass
  SELECTION_17:
  - -Enc
  SELECTION_18:
  - powershell
  SELECTION_19:
  - reg
  SELECTION_2:
  - ' -w '
  SELECTION_20:
  - add
  SELECTION_21:
  - HKCU\software\microsoft\windows\currentversion\run
  SELECTION_22:
  - bypass
  SELECTION_23:
  - -noprofile
  SELECTION_24:
  - -windowstyle
  SELECTION_25:
  - hidden
  SELECTION_26:
  - new-object
  SELECTION_27:
  - system.net.webclient
  SELECTION_28:
  - .download
  SELECTION_29:
  - iex
  SELECTION_3:
  - hidden
  SELECTION_30:
  - New-Object
  SELECTION_31:
  - Net.WebClient
  SELECTION_32:
  - .Download
  SELECTION_33:
  - (New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1
  - (New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')
  - Write-ChocolateyWarning
  SELECTION_4:
  - ' -c '
  SELECTION_5:
  - '[Convert]::FromBase64String'
  SELECTION_6:
  - ' -w '
  SELECTION_7:
  - hidden
  SELECTION_8:
  - -noni
  SELECTION_9:
  - -nop
  condition: (((((((SELECTION_1 and SELECTION_2 and SELECTION_3 and SELECTION_4 and
    SELECTION_5) or (SELECTION_6 and SELECTION_7 and SELECTION_8 and SELECTION_9 and
    SELECTION_10 and SELECTION_11 and SELECTION_12)) or (SELECTION_13 and SELECTION_14
    and SELECTION_15 and SELECTION_16 and SELECTION_17)) or (SELECTION_18 and SELECTION_19
    and SELECTION_20 and SELECTION_21)) or (SELECTION_22 and SELECTION_23 and SELECTION_24
    and SELECTION_25 and SELECTION_26 and SELECTION_27 and SELECTION_28)) or (SELECTION_29
    and SELECTION_30 and SELECTION_31 and SELECTION_32)) and  not ((SELECTION_33)))
falsepositives:
- Unknown
id: fce5f582-cc00-41e1-941a-c6fabf0fdb8c
level: high
logsource:
  definition: Script block logging must be enabled for 4104, Module Logging must be
    enabled for 4103
  product: windows
  service: powershell
modified: 2022/02/21
status: deprecated
tags:
- attack.execution
- attack.t1059.001
