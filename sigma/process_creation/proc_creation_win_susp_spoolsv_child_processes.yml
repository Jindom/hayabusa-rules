
title: Suspicious Spool Service Child Process
author: Justin C. (@endisphotic), @dreadphones (detection), Thomas Patzke (Sigma rule)
date: 2021/07/11
description: Detects suspicious print spool service (spoolsv.exe) child processes.
detection:
  SELECTION_1:
    ParentImage: '*\\spoolsv.exe'
  SELECTION_10:
    Image: '*\powershell.exe'
  SELECTION_11:
    CommandLine: '*.spl*'
  SELECTION_12:
    Image: '*\rundll32.exe'
  SELECTION_13:
    CommandLine: '*rundll32.exe'
  SELECTION_2:
    IntegrityLevel: System
  SELECTION_3:
    Image:
    - '*\gpupdate.exe'
    - '*\whoami.exe'
    - '*\nltest.exe'
    - '*\taskkill.exe'
    - '*\wmic.exe'
    - '*\taskmgr.exe'
    - '*\sc.exe'
    - '*\findstr.exe'
    - '*\curl.exe'
    - '*\wget.exe'
    - '*\certutil.exe'
    - '*\bitsadmin.exe'
    - '*\accesschk.exe'
    - '*\wevtutil.exe'
    - '*\bcdedit.exe'
    - '*\fsutil.exe'
    - '*\cipher.exe'
    - '*\schtasks.exe'
    - '*\write.exe'
    - '*\wuauclt.exe'
  SELECTION_4:
    Image: '*\net.exe'
  SELECTION_5:
    CommandLine: '*start*'
  SELECTION_6:
    Image: '*\cmd.exe'
  SELECTION_7:
    CommandLine:
    - '*.spl*'
    - '*route add*'
    - '*program files*'
  SELECTION_8:
    Image: '*\netsh.exe'
  SELECTION_9:
    CommandLine:
    - '*add portopening*'
    - '*rule name*'
  condition: ((SELECTION_1 and SELECTION_2) and (((((SELECTION_3 or (SELECTION_4 and  not
    (SELECTION_5))) or (SELECTION_6 and  not (SELECTION_7))) or (SELECTION_8 and  not
    (SELECTION_9))) or (SELECTION_10 and  not (SELECTION_11))) or (SELECTION_12 and
    SELECTION_13)))
falsepositives:
- None known
fields:
- Image
- CommandLine
id: dcdbc940-0bff-46b2-95f3-2d73f848e33b
level: high
logsource:
  category: process_creation
  product: windows
references:
- https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries/blob/master/Exploits/Print%20Spooler%20RCE/Suspicious%20Spoolsv%20Child%20Process.md
status: stable
tags:
- attack.execution
- attack.t1203
- attack.privilege_escalation
- attack.t1068
